<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Category</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      width:100vw; height:100vh; background:black; overflow:hidden;
      font-family:sans-serif; display:flex; flex-direction:column; align-items:center;
    }
    .page-wrapper{
      aspect-ratio:9 / 16; width:100%; height:100vh; max-width:56.25vh;
      display:flex; flex-direction:column; background:white;
    }
    .banner-container{ position:relative; width:100%; aspect-ratio:9 / 5; overflow:hidden; }
    .banner-container video{ width:100%; height:100%; object-fit:cover; display:block; background:black; }
    .back-to-menu{
      position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,.6); color:#fff;
      padding:16px 20px; border-radius:12px; font-size:18px; z-index:10; user-select:none;
    }
    .shop-grid{
      flex:1; display:grid; grid-template-columns:repeat(4,1fr); grid-auto-rows:1fr;
      gap:6px; padding:10px; overflow-y:auto; width:100%; background:white;
    }
    .shop-card{
      background:#222; border-radius:8px; overflow:hidden; display:flex; flex-direction:column;
      align-items:center; text-align:center; color:white; font-size:14px;
    }
    .shop-card img{ width:100%; height:auto; object-fit:cover; display:block; }
    .shop-card .shop-name{ padding:4px; }
    .shop-card.empty{ background:#ddd; border:1px dashed #aaa; }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="banner-container">
      <video id="bannerVideo" autoplay muted playsinline preload="metadata">
        <source id="bannerSrc" src="" type="video/mp4" />
      </video>
      <div id="backBtn" class="back-to-menu">↩️ back to<br>main menu</div>
    </div>
    <div class="shop-grid" id="shopGrid"></div>
  </div>

<script>
  // ===== PARAMETERS =====
  const qs = new URLSearchParams(location.search);
  const type = qs.get('type') || 'dining';
  const projectId = qs.get('project_id') || '';

  // ===== BASE PATH (สำคัญ แก้ 404) =====
  // ถ้าหน้านี้ถูกเสิร์ฟจาก /ann/... ให้ลิงก์ทุกอย่างขึ้นต้นด้วย /ann/
  // แก้ไขเป็น relative path สำหรับ local development
  const withBase = (p) => './' + p.replace(/^\.?\//, '');

  // ===== BANNER VIDEO (ยึด path ที่ยืนยันแล้ว) =====
  const bannerVideo = document.getElementById('bannerVideo');
  const bannerSrc   = document.getElementById('bannerSrc');
  bannerSrc.src = withBase(`medias/${type}.mp4`);
  bannerVideo.muted = true;
  bannerVideo.setAttribute('playsinline', '');
  bannerVideo.setAttribute('autoplay', '');
  bannerVideo.load();
  bannerVideo.play().catch(()=>{});

  // ===== BACK TO MENU (พก project_id กลับ) =====
  const backBtn = document.getElementById('backBtn');
  backBtn.onclick = () => {
    const u = new URL('./menu.html', location.origin);
    if (projectId) u.searchParams.set('project_id', projectId);
    location.href = u.toString();
  };

  // ===== LOAD SHOPS =====
  fetch(withBase(`data/${type}.json`))
    .then(r => r.json())
    .then(list => {
      const grid = document.getElementById('shopGrid');
      grid.innerHTML = '';
      let count = 0;
      (list || []).forEach(shop => {
        const div = document.createElement('div');
        div.className = 'shop-card';
        div.innerHTML = `
          <img src="${shop.image}" alt="${shop.name}">
          <div class="shop-name">${shop.name}</div>
        `;
        grid.appendChild(div);
        count++;
      });
      for (let i = count; i < 12; i++) {
        const div = document.createElement('div');
        div.className = 'shop-card empty';
        grid.appendChild(div);
      }
    })
    .catch(err => console.error('Error loading shop data:', err));

  // ===== AUTO RETURN 1 นาที → signage.html (อยู่โฟลเดอร์เดียวกับหน้านี้) =====
  let timeout;
  function resetInactivityTimer(){
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      const u = new URL('./menu.html', location.origin);
      if (projectId) u.searchParams.set('project_id', projectId);
      location.href = u.toString();
    }, 60000);
  }
  ['click','touchstart','mousemove'].forEach(ev =>
    window.addEventListener(ev, resetInactivityTimer)
  );
  resetInactivityTimer();

  // ===== VERSION POLL (ตามเดิม) =====
  window.currentVersion = '';
  setInterval(() => {
    fetch('./version.txt', { cache: 'no-store' })
      .then(res => res.text())
      .then(v => {
        const t = v.trim();
        if (window.currentVersion && window.currentVersion !== t) location.reload();
        window.currentVersion = t;
      })
      .catch(()=>{});
  }, 60000);
</script>
</body>
</html>